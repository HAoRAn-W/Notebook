# 进程和线程的区别

- 进程是资源管理的基本单位。线程是 CPU 调度的基本单位
- 线程切换上下文并进程更快
- 进程内的线程共享资源，线程本身不拥有系统资源
- 创建和销毁进程需要的开销大于线程

# 协程和线程

- 线程是同步机制，协程是异步机制
- 线程是抢占式，协程是非抢占式。用户需要释放协程的使用权给其他协程。
- 协程不由操作系统内核管理，完全由程序控制
- 协程可以保留上一次调用时的状态

# 并发和并行

并发是宏观的多个程序同时运行，但是在任意时刻只有一个程序在执行

并行是同一时刻有多个程序运行，所以需要多核处理器才可以完成

# 进程和线程的切换

进程：

1. 切换页表以使用新的地址空间，上下文被切换后，CPU 缓存的内存地址就作废了
2. 切换内核栈和硬件上下文

线程：

只需要切换内核栈和硬件上下文。因为进程有自己的虚拟地址空间，线程共享这个地址空间，所以同一个进程中的线程切换不需要转换虚拟地址空间

## 虚拟地址空间的切换为什么耗时

进程有自己的虚拟地址空间，切换进程时，需要把虚拟地址转换为物理地址。此时需要查找页表，这个过程是很慢的。

因此可以用 Cache 来缓存常用的地址映射（TLB, transition lookaside buffer），加速页表查找

每个进程都有自己的页表，切换进程后页表也要切换，此时 TLB 就失效了。Cache 命中率低，导致虚拟地址到物理地址的转换变慢。

# 进程间通信方式

## 管道

### 匿名管道

父子进程间通信 pipe()

单向

内核对管道进行同步和互斥

进程退出，管道也就释放了

### 命名管道

适用于任意进程间通信，mkfifo()

单向

存在于文件系统中，不会随进程退出而消失

## 信号

可以在任一时刻发送给进程

常用信号：

1. SIGHUP: 用户从终端注销后，所有已经启动的进程都会收到，默认处理的终止进程
2. SIGINT: 程序终止信号，Ctrl+C
3. SIGKILL: 用户终止进程执行，kill -9 pid
4. SIGTERM: 结束进程，kill pid
5. SIGFPE: 运算出现致命错误，如除 0，数据溢出
6. SIGCLD: 子进程退出信号，如果父进程没有忽略或处理，子进程退出后会成为僵尸进程。

## 信号量 semaphore

一个计数器，用来控制多个进程对共享资源的访问。是一种锁机制。防止某进程正在访问共享资源的时候其他进程页访问该资源。

信号量会有初值（>0），每当有进程申请使用信号量，通过一个 P 操作来对信号量进行-1 操作，当计数器减到 0 的时候就说明没有资源了，其他进程要想访问就必须等待（具体怎么等还有说法，比如忙等待或者睡眠），当该进程执行完这段工作（我们称之为临界区）之后，就会执行 V 操作来对信号量进行+1 操作

当有进程要求使用共享资源时，需要执行以下操作：

1. 系统首先要检测该资源的信号量；

2. 若该资源的信号量值大于 0，则进程可以使用该资源，此时，进程将该资源的信号量值减 1；

3. 若该资源的信号量值为 0，则进程进入休眠状态，直到信号量值大于 0 时进程被唤醒，访问该资源；

当进程不再使用由一个信号量控制的共享资源时，

## 消息队列 TODO

消息的链接表，如 Posix 消息队列和 System V 消息队列。有足够权限的进程可以向队列添加消息，有读权限的进程可以读走消息。

独立于收发进程而存在，

## 共享内存

映射一段可以被其他进程访问的内存，速度快。需要处理同步的问题。

## socket

不同主机间的进程通信

# 进程同步的方式

## 临界区

串行化访问公共资源或代码。但只可以同步同一个进程内的线程，无法同步多个进程中的线程

## 互斥量

可命名，因此可以在不同进程间实现对资源的安全共享。只有拥有互斥兑现的线程才有访问资源的权限

## 信号量

控制一个有数量的用户资源。允许多个进程同时访问一个资源，但有最大访问的数目。
