# 计算机网络协议栈

## OSI 七层模型

理论模型：

- 应用层：为应用程序提供服务，如 DNS,HTTP，SMTP
- 表示层：负责数据格式转换，如加解密，压缩解压等
- 会话层：负责在网络中两节点之间简历，维持，终止通信。如服务器验证用户登录
- 运输层：向主机进程提供数据传输服务。TCP：面向连接，可靠的；UDP：无连接，最大努力传输的，不可靠。
- 网络层：选择合适的路由和交换节点，确保数据及时传送，如 IP
- 数据链路层：将网络层数据包装成帧，在相邻节点的链路上传输，如 MAC
- 物理层：相邻节点比特流的传输，屏蔽传输介质的不同

## TCP/IP 四层模型

网络接口层，网络层，运输层，应用层

# TCP 与 UDP 的区别

|          | UDP                            | TCP                          |
| -------- | ------------------------------ | ---------------------------- |
| 连接     | 无连接                         | 面向连接                     |
| 可靠性   | 不可靠                         | 可靠传输：流量控制，拥塞控制 |
| 有序性   | 无序                           | 有序                         |
| 传输速度 | 快                             | 慢                           |
| 对象个数 | 一对一，一对多，多对一，多对多 | 一对一                       |
| 传输方式 | 报文                           | 字节流                       |
| 首部开销 | 小，8 字节                     | 大，20~60 字节               |

# TCP 三次握手

![TCP 3 handshake](../assets/Network/tcp-handshake.png)
Client: SYN, SYN = 1, 随机初始序列号 seq=x。SYN-SENT

Server: SYN-ACK, SYN = 1, ACK = 1, ack = x + 1,随机初始序列号 seq=y，SYN_RECV

Client: ACK, ACK = 1, seq = x + 1, ack = y + 1, ESTABLISHED

Server: ESTABLISHED

三次挥手可以让双方都确认自己的接收能力和发送能力都是正常的。

仅靠前两次握手无法确认功能正常，且有可能发生第一次连接请求在后一次连接断开后才到达，而 client 并没有意识到产生了新的请求，从而导致服务器单方面等待，资源浪费。

第二次握手是 SYN 和 ACK 一起发送的，所以只需要三次，而不是四次握手

# SYN 泛洪攻击

DOS 攻击的一种，大量发送半连接请求，耗费服务器资源。服务器不断重发 SYN-ACK 而得不到回应，从而影响了正常的连接请求。

## 三次握手最后一个 ACK 丢失：

服务端根据超时重传机制重发 SYN-ACK 包，知道超时关闭连接。

客户端以为连接已经建立，发送数据时会受到服务端的 RST 包，此时才得知连接失败，断开连接。

## 监测

服务器上有大量半连接状态，且源 IP 随机

## 防范

防火墙，路由器过滤

加固 TCP/IP 协议栈防范：增加最大半连接数量，缩短超时时间

# TCP 四次挥手

![connection close](../assets/Network/connection-close.png)
客户端主动关闭连接：FIN=1，ACK=1，seq=u=x+1, ack=k=y+1， FIN_WAIT_1

服务端接收到 FIN 立马发出 ACK，seq=k, ack=u+1, CLOSE_WAIT

客户端收到 ACK，进入 FIN_WAIT_2

服务端发送 FIN，seq=m 即上次发送报文最后一个字节的序号+1，ack=u+1，LAST_ACK

客户端发送 ACK，ack=m+1,ack=u+1, TIME_WAIT 2msl（2 倍最大报文寿命）TIME_WAIT，然后 CLOSE

服务端收到 ACK，CLOSED

## TIME_WAIT 2 MSL

1. 确保 ACK 可以到达服务端，并接受超时重传的 FIN

2. 等待 2 MSL 是为了防止上一个连接中丢失的报文，在下一次相同两方连接建立之后送达, 导致客户端无法确定报文是否是新的连接的报文。（TCP 要求 2MSL 内不使用相同的序列号）

# TCP 如何保证传输可靠性
